# Workflow CI untuk MLProject
# Melatih ulang model dan menyimpan artefak

name: Train and Log Model

on:
  push:
    paths:
      - 'MLProject/**'
  workflow_dispatch:

jobs:
  train:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          use-mamba: false
          auto-activate-base: false
      - name: Install MLflow
        run: pip install mlflow==2.12.1
      - name: Run MLflow Project
        run: mlflow run MLProject -P data_path=spam_email_dataset_cleaned.csv
        shell: bash -l {0}
      - name: Upload model artifact
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: mlruns/

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker image with MLflow
        run: |
          # Temukan run id terakhir (terbaru) dari mlruns/0
          RUN_ID=$(ls mlruns/0 | grep -E '^[0-9a-f]+' | sort | tail -n1)
          # Build docker image dari model artefak (ganti model_nb_alpha_0.1.pkl jika model utama berbeda)
          mlflow models build-docker -m mlruns/0/$RUN_ID/artifacts/model_nb_alpha_0.1.pkl -n ${{ secrets.DOCKERHUB_USERNAME }}/mlproject-model:latest

      - name: Push Docker image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/mlproject-model:latest
