name: ML Training CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    paths:
      - "MLProject/**"
      - ".github/workflows/train.yml"

  pull_request:
    branches: [main]

  workflow_dispatch:

env:
  MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
  MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
  MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
  MLFLOW_DISABLE_TELEMETRY: 1

  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

jobs:
  train-model:
    runs-on: ubuntu-latest

    steps:
    # =============================
    # Checkout
    # =============================
    - name: Checkout repository
      uses: actions/checkout@v4

    # =============================
    # Python Setup
    # =============================
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Create virtualenv
      run: |
        python -m venv venv
        source venv/bin/activate
        pip install --upgrade pip

    # =============================
    # Install Dependencies
    # =============================
    - name: Install ML dependencies
      run: |
        source venv/bin/activate
        pip install mlflow dagshub pandas numpy scikit-learn matplotlib joblib

    # =============================
    # Verify Dataset
    # =============================
    - name: Verify dataset exists
      run: |
        ls -lh MLProject/spam_email_dataset_cleaned.csv

    # =============================
    # Debug MLflow Auth (AMAN)
    # =============================
    - name: Debug MLflow env
      run: |
        echo "MLFLOW_TRACKING_URI=$MLFLOW_TRACKING_URI"
        echo "MLFLOW_TRACKING_USERNAME=$MLFLOW_TRACKING_USERNAME"

    # =============================
    # Run MLflow Project
    # =============================
    - name: Run MLflow training
      working-directory: MLProject
      run: |
        source ../venv/bin/activate
        mlflow run . \
          --env-manager=local \
          -P data_path=spam_email_dataset_cleaned.csv

    # =============================
    # Docker Login
    # =============================
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # =============================
    # Build Docker Image
    # =============================
    - name: Build Docker image
      run: |
        docker build \
          -t ${{ secrets.DOCKERHUB_USERNAME }}/spam-email-detector:latest \
          -t ${{ secrets.DOCKERHUB_USERNAME }}/spam-email-detector:${{ github.sha }} \
          MLProject

    # =============================
    # Push Docker Image
    # =============================
    - name: Push Docker image
      run: |
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/spam-email-detector:latest
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/spam-email-detector:${{ github.sha }}

    # =============================
    # Upload Artifacts
    # =============================
    - name: Upload ML artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ml-artifacts-${{ github.run_number }}
        path: MLProject/artifacts/
        retention-days: 30

    # =============================
    # PR Comment
    # =============================
    - name: Comment PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ðŸ¤– ML Pipeline Success

            âœ… Training & Docker build completed

            **Docker Image**
            - \`${process.env.DOCKERHUB_USERNAME}/spam-email-detector:latest\`
            - Commit: \`${context.sha}\`

            Artifacts tersedia di GitHub Actions.
            `
                      })